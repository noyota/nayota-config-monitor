const EventEmitter=require("events").EventEmitter,asyncHandler=require("express-async-handler"),formidable=require("formidable"),request=require("request"),fs=require("fs"),fsPromises=fs.promises,path=require("path"),xml2js=require("xml2js"),XLSX=require("xlsx"),gm=require("gm"),imageMagick=gm.subClass({imageMagick:!0}),SDK=require(path.resolve("./server/utils/hik-camera-sdk.js")),parseString=new xml2js.Parser({explicitArray:!1}).parseStringPromise,mongoose=require("mongoose"),BlackList=mongoose.model("BlackList");class HttpRoute extends EventEmitter{constructor(e,t){super(),t.route("/hik-traffic-ca/records").post(asyncHandler(async(e,t)=>{const a=new formidable.IncomingForm;a.keepExtensions=!0;const r=`upload/${(new Date).getFullYear()}/${(new Date).getMonth()+1}/${(new Date).getDate()}`,i=path.resolve("./assets/"+r);await fsPromises.mkdir(i,{recursive:!0}),a.uploadDir=i;const{files:s}=await new Promise((t,r)=>{a.parse(e,(e,a,i)=>{e&&r(e),t({fields:a,files:i})})}),l=await fsPromises.readFile(s["anpr.xml"].path),o=await parseString(l),{ipAddress:n,macAddress:c,channelID:u,dateTime:p,activePostCount:f,eventType:d,eventState:m,eventDescription:h,ANPR:v}=o.EventNotificationAlert,{country:g,licensePlate:w,direction:y,confidenceLevel:k,plateType:P,plateColor:D,licenseBright:b,vehicleInfo:S,pictureInfoList:E,originalLicensePlate:x}=v;console.log(c,g,w,y,k,P,D,f,d,m,h,b,S,E,x);const R=await BlackList.findOne({"value.车牌":w});let q=2;null!=R&&(q=parseInt(R.value["黑白名单"]));const L={};L.file=fs.createReadStream(s["detectionPicture.jpg"].path);const Y=process.env.RESOURCE_SERVER,I=await new Promise((e,t)=>{request.post({url:Y+"/api/uploads",formData:L},function(a,r,i){if(a)return console.log("upload failed:"+a),t(s["detectionPicture.jpg"].path);i=JSON.parse(i),e(Y+i.data)})}),N=i+"/"+((new Date).getTime()+"_platePicture.jpg");let j,M,X,A,_="",H="";if(E.pictureInfo.length>1){j=E.pictureInfo[1].plateRect.X,M=E.pictureInfo[1].plateRect.Y,X=E.pictureInfo[1].plateRect.width,A=E.pictureInfo[1].plateRect.height,_=await new Promise((e,t)=>{imageMagick(s["detectionPicture.jpg"].path).crop(X,A,j,M).write(N,function(a){if(a)return t(400);e(N)})});const e={};400!==_&&(e.file=fs.createReadStream(_),H=await new Promise((t,a)=>{request.post({url:Y+"/api/uploads",formData:e},async function(e,r,i){if(e)return a(_);i=JSON.parse(i),t(Y+i.data)})}))}I.indexOf(Y)>-1&&await fsPromises.unlink(path.resolve(s["detectionPicture.jpg"].path)),this.emit(`node${c}`,{0:JSON.stringify({ipAddress:n,macAddress:c,channelID:u,dateTime:p,country:g,licensePlate:w,plateType:P,plateColor:D,type:q,direction:y,confidenceLevel:k,plateRect:E.pictureInfo.length>1?E.pictureInfo[1].plateRect:null,image:I,vehicle_body:S.vehileModel,vehicle_mark:S.vehileType,vehicle_color:S.color,smallPath:H}),1:w,2:q,3:I,4:H}),t.send("success")}))}async config(e){const t=e.attribute.filter(e=>"username"===e.key)[0].value,a=e.attribute.filter(e=>"password"===e.key)[0].value,r=e.attribute.filter(e=>"channel"===e.key)[0].value,i=e.attribute.filter(e=>"ip"===e.key)[0].value,s=e.attribute.filter(e=>"port"===e.key)[0].value,l={url:e.url,username:t,password:a,channel:{id:r}},o=new SDK(l);await o.setEventHttpHost(i,s,"/http-api/hik-traffic-ca/records"),await o.setAlarmHttpPushProtocol()}static async import(e,t,a){const r=e.attribute.filter(e=>"username"===e.key)[0].value,i=e.attribute.filter(e=>"password"===e.key)[0].value,s=e.attribute.filter(e=>"channel"===e.key)[0].value,l={url:e.url,username:r,password:i,channel:{id:s}},o=new SDK(l),n=await HttpRoute.rosterEncode(a);await o.setLicensePlateAuditData(n.buffer)}static async rosterEncode(e){e=e.map((e,t)=>({"No.":t,"Plate No.":e.value["车牌"],"Group(0 black list, 1 white list)":e.value["黑白名单"],"Expiry Date (Format: YYYY-MM-DD, e.g., 2017-12-07)":e.value["有效日期"]}));const t={SheetNames:["sheet1"],Sheets:{sheet1:XLSX.utils.json_to_sheet(e,{header:["No.","Plate No.","Group(0 black list, 1 white list)","Expiry Date (Format: YYYY-MM-DD, e.g., 2017-12-07)"]})}};return{fileName:"plate.xls",buffer:XLSX.write(t,{bookType:"biff8",type:"buffer"})}}static async rosterDecode(e){const t=XLSX.read(e);return XLSX.utils.sheet_to_json(t.Sheets.sheet1).map(e=>({value:{"车牌":e["Plate No."],"黑白名单":e["Group(0 black list, 1 white list)"],"有效日期":e["Expiry Date (Format: YYYY-MM-DD, e.g., 2017-12-07)"]}}))}async export(e,t){const a=e.attribute.filter(e=>"username"===e.key)[0].value,r=e.attribute.filter(e=>"password"===e.key)[0].value,i=e.attribute.filter(e=>"channel"===e.key)[0].value,s={url:e.url,username:a,password:r,channel:{id:i}},l=new SDK(s),o=await l.getLicensePlateAuditData();console.log(o)}}module.exports=HttpRoute;